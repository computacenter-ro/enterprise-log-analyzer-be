name: Setup Telegraf Agent

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'configure'
        type: choice
        options:
          - configure
          - restart
          - stop
          - status

jobs:
  setup-telegraf:
    runs-on: ["self-hosted", "ccro-macstudio-one"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Telegraf (if not installed)
        run: |
          if ! command -v telegraf &> /dev/null; then
            echo "Installing Telegraf..."
            brew install telegraf
          else
            echo "Telegraf already installed: $(telegraf --version)"
          fi

      - name: Install jq (for macOS log script)
        run: |
          if ! command -v jq &> /dev/null; then
            brew install jq
          fi

      - name: Determine Homebrew prefix
        id: brew
        run: |
          BREW_PREFIX=$(brew --prefix)
          echo "prefix=$BREW_PREFIX" >> $GITHUB_OUTPUT
          echo "Homebrew prefix: $BREW_PREFIX"

      - name: Create Telegraf directories
        run: |
          mkdir -p "${{ steps.brew.outputs.prefix }}/etc/telegraf/scripts"

      - name: Copy Telegraf configuration
        run: |
          cp infrastructure/telegraf/telegraf.conf "${{ steps.brew.outputs.prefix }}/etc/telegraf.conf"
          echo "Configuration copied to ${{ steps.brew.outputs.prefix }}/etc/telegraf.conf"

      - name: Copy macOS log script
        run: |
          cp infrastructure/telegraf/scripts/macos_log.sh "${{ steps.brew.outputs.prefix }}/etc/telegraf/scripts/"
          chmod +x "${{ steps.brew.outputs.prefix }}/etc/telegraf/scripts/macos_log.sh"
          echo "Script copied and made executable"

      - name: Create Telegraf environment file
        run: |
          cat > "${{ steps.brew.outputs.prefix }}/etc/telegraf/telegraf.env" << 'EOF'
          # Telegraf Environment Variables
          # Auto-generated by GitHub Actions - DO NOT COMMIT

          TELEGRAF_TOKEN=${{ secrets.TELEGRAF_TOKEN }}
          TELEGRAF_AGENT_ID=${{ secrets.TELEGRAF_AGENT_ID }}
          BACKEND_URL=${{ secrets.TELEGRAF_BACKEND_URL || 'http://localhost:8012' }}
          ENVIRONMENT=production
          REGION=mac-studio-one
          SERVICE_GROUP=aiops
          TELEGRAF_SCRIPTS_PATH=${{ steps.brew.outputs.prefix }}/etc/telegraf/scripts
          EOF

          # Secure the file
          chmod 600 "${{ steps.brew.outputs.prefix }}/etc/telegraf/telegraf.env"
          echo "Environment file created"

      - name: Create Telegraf launch configuration
        run: |
          # Create a wrapper script that sources the env file
          cat > "${{ steps.brew.outputs.prefix }}/etc/telegraf/telegraf-wrapper.sh" << 'EOF'
          #!/bin/bash
          set -a
          source "${{ steps.brew.outputs.prefix }}/etc/telegraf/telegraf.env"
          set +a
          exec telegraf "$@"
          EOF
          chmod +x "${{ steps.brew.outputs.prefix }}/etc/telegraf/telegraf-wrapper.sh"

      - name: Configure Telegraf action
        run: |
          case "${{ github.event.inputs.action }}" in
            configure)
              echo "Restarting Telegraf with new configuration..."
              brew services restart telegraf || brew services start telegraf
              ;;
            restart)
              echo "Restarting Telegraf..."
              brew services restart telegraf
              ;;
            stop)
              echo "Stopping Telegraf..."
              brew services stop telegraf
              ;;
            status)
              echo "Telegraf status:"
              brew services list | grep telegraf || echo "Telegraf not running as service"
              ;;
          esac

      - name: Verify Telegraf is running
        if: github.event.inputs.action == 'configure' || github.event.inputs.action == 'restart'
        run: |
          sleep 5
          if pgrep -x telegraf > /dev/null; then
            echo "✅ Telegraf is running"
            brew services list | grep telegraf
          else
            echo "❌ Telegraf failed to start"
            # Check logs
            tail -20 "${{ steps.brew.outputs.prefix }}/var/log/telegraf.log" 2>/dev/null || true
            exit 1
          fi

      - name: Test configuration syntax
        if: github.event.inputs.action == 'configure'
        run: |
          set -a
          source "${{ steps.brew.outputs.prefix }}/etc/telegraf/telegraf.env"
          set +a
          telegraf --config "${{ steps.brew.outputs.prefix }}/etc/telegraf.conf" --test || true
